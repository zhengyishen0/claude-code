#!/bin/bash
# AVD management - start/stop/snapshot WeChat tablet emulator
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AVD_NAME="WeChat_Tablet"
SNAPSHOT_NAME="wechat_logged_in"
EMULATOR="/opt/homebrew/share/android-commandlinetools/emulator/emulator"

usage() {
    echo "Usage: $0 <command>"
    echo ""
    echo "Commands:"
    echo "  start     Start AVD (resumes from snapshot if exists)"
    echo "  stop      Save snapshot and stop AVD"
    echo "  snapshot  Save current state as snapshot"
    echo "  kill      Force kill AVD without saving"
    echo "  status    Show AVD status"
    exit 1
}

start_avd() {
    if adb devices | grep -q "emulator-5554"; then
        echo "AVD already running"
        return
    fi
    echo "Starting AVD from snapshot..."
    "$EMULATOR" -avd "$AVD_NAME" -snapshot "$SNAPSHOT_NAME" -no-snapshot-save -no-audio &
    echo "Waiting for device..."
    adb wait-for-device
    adb -s emulator-5554 shell getprop sys.boot_completed | grep -q 1 || sleep 5
    echo "AVD ready"
    connect_wifi
}

connect_wifi() {
    # Fix cold boot WiFi issue by toggling WiFi
    echo "Connecting WiFi..."
    adb -s emulator-5554 shell svc wifi disable 2>/dev/null || true
    sleep 1
    adb -s emulator-5554 shell svc wifi enable 2>/dev/null || true
    sleep 2
    if adb -s emulator-5554 shell ping -c 1 -W 2 8.8.8.8 &>/dev/null; then
        echo "WiFi connected"
    else
        echo "WiFi may need manual reconnection"
    fi
}

stop_avd() {
    echo "Saving snapshot..."
    adb -s emulator-5554 emu avd snapshot save "$SNAPSHOT_NAME" 2>/dev/null || true
    echo "Stopping AVD..."
    adb -s emulator-5554 emu kill 2>/dev/null || true
    echo "Done"
}

snapshot_avd() {
    echo "Saving snapshot '$SNAPSHOT_NAME'..."
    adb -s emulator-5554 emu avd snapshot save "$SNAPSHOT_NAME"
    echo "Done"
}

kill_avd() {
    echo "Force killing AVD..."
    pkill -f qemu-system-aarch64 2>/dev/null || true
    echo "Done"
}

status_avd() {
    echo "=== AVD Status ==="
    if adb devices | grep -q "emulator-5554"; then
        echo "Status: Running"
        adb -s emulator-5554 shell getprop ro.product.model
    else
        echo "Status: Stopped"
    fi
}

case "${1:-}" in
    start) start_avd ;;
    stop) stop_avd ;;
    snapshot) snapshot_avd ;;
    kill) kill_avd ;;
    status) status_avd ;;
    *) usage ;;
esac
