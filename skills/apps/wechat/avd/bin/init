#!/bin/bash
# Initialize WeChat database - auto-extract key, pull, decrypt, index
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WECHAT_DIR="$(dirname "$SCRIPT_DIR")"
DATA_DIR="$WECHAT_DIR/data"
LIB_DIR="$WECHAT_DIR/lib"
CONFIG_FILE="$DATA_DIR/config.env"

WECHAT_DB_PATH="/data/data/com.tencent.mm/MicroMsg"
ENCRYPTED_DB="$DATA_DIR/EnMicroMsg.db"
DECRYPTED_DB="$DATA_DIR/wechat.db"

mkdir -p "$DATA_DIR"

# Load config if exists
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"

# Check dependencies
check_deps() {
  local missing=""
  command -v adb >/dev/null || missing="$missing adb"
  command -v sqlcipher >/dev/null || missing="$missing sqlcipher"
  command -v frida >/dev/null || missing="$missing frida"

  if [ -n "$missing" ]; then
    echo "Missing:$missing" >&2
    echo "Install: brew install android-platform-tools sqlcipher" >&2
    echo "         pip install frida-tools" >&2
    exit 1
  fi
}

# Check emulator connection
check_emulator() {
  if ! adb devices 2>/dev/null | grep -q "device$"; then
    echo "Error: No Android device/emulator connected" >&2
    echo "Start your emulator and try again" >&2
    exit 1
  fi
}

# Extract encryption key via Frida
extract_key() {
  echo "Extracting encryption key..." >&2
  echo "Please open WeChat on the emulator and wait..." >&2

  local output
  output=$(timeout 30 frida -U -f com.tencent.mm -l "$LIB_DIR/extract-key.js" --no-pause 2>&1 || true)

  local key=$(echo "$output" | grep "^WECHAT_KEY=" | head -1 | cut -d= -f2)
  local db_path=$(echo "$output" | grep "^WECHAT_DB_PATH=" | head -1 | cut -d= -f2)

  if [ -z "$key" ]; then
    echo "Error: Could not extract key" >&2
    echo "Make sure WeChat opens and accesses a chat" >&2
    exit 1
  fi

  export WECHAT_KEY="$key"
  echo "WECHAT_KEY='$key'" > "$CONFIG_FILE"

  if [ -n "$db_path" ]; then
    export WECHAT_DB_FULL_PATH="$db_path"
    echo "WECHAT_DB_FULL_PATH='$db_path'" >> "$CONFIG_FILE"
  fi

  echo "Key extracted and saved" >&2
}

# Find WeChat database on emulator
find_wechat_db() {
  echo "Finding WeChat database..." >&2

  local uin_dir=$(adb shell "ls -1 $WECHAT_DB_PATH 2>/dev/null | grep -v '^$' | head -1" 2>/dev/null | tr -d '\r\n')

  if [ -z "$uin_dir" ]; then
    echo "Error: WeChat data not found. Is WeChat installed and logged in?" >&2
    exit 1
  fi

  echo "$WECHAT_DB_PATH/$uin_dir/EnMicroMsg.db"
}

# Pull database from emulator
pull_database() {
  local db_path="$1"
  echo "Pulling database..." >&2

  adb root >/dev/null 2>&1 || true
  sleep 1

  if ! adb pull "$db_path" "$ENCRYPTED_DB" 2>/dev/null; then
    echo "Trying with su..." >&2
    adb shell "su -c 'cp $db_path /data/local/tmp/EnMicroMsg.db'" 2>/dev/null
    adb pull /data/local/tmp/EnMicroMsg.db "$ENCRYPTED_DB"
    adb shell "rm /data/local/tmp/EnMicroMsg.db" 2>/dev/null || true
  fi

  echo "Pulled: $(ls -lh "$ENCRYPTED_DB" | awk '{print $5}')" >&2
}

# Decrypt database
decrypt_database() {
  echo "Decrypting..." >&2
  rm -f "$DECRYPTED_DB"

  sqlcipher "$ENCRYPTED_DB" << EOF
PRAGMA key = '$WECHAT_KEY';
PRAGMA cipher_compatibility = 1;
ATTACH DATABASE '$DECRYPTED_DB' AS plaintext KEY '';
SELECT sqlcipher_export('plaintext');
DETACH DATABASE plaintext;
EOF

  if [ ! -f "$DECRYPTED_DB" ]; then
    echo "Error: Decryption failed. Key may be wrong." >&2
    echo "Delete $CONFIG_FILE and try again" >&2
    exit 1
  fi

  echo "Decrypted: $(ls -lh "$DECRYPTED_DB" | awk '{print $5}')" >&2
}

# Build FTS5 index
build_search_index() {
  echo "Building search index..." >&2

  sqlite3 "$DECRYPTED_DB" << 'EOF'
DROP TABLE IF EXISTS message_fts;
CREATE VIRTUAL TABLE message_fts USING fts5(
  msgId, talker, content, timestamp, type,
  tokenize='unicode61'
);

INSERT INTO message_fts (msgId, talker, content, timestamp, type)
SELECT
  m.msgId,
  COALESCE(cr.displayname, c.conRemark, c.nickname, m.talker) as talker,
  CASE
    WHEN m.type = 1 THEN m.content
    WHEN m.type = 3 THEN '[图片]'
    WHEN m.type = 34 THEN COALESCE(v.content, '[语音]')
    WHEN m.type = 43 THEN '[视频]'
    WHEN m.type = 47 THEN '[表情]'
    WHEN m.type = 49 THEN
      CASE
        WHEN m.content LIKE '%<type>6</type>%' THEN '[文件]'
        WHEN m.content LIKE '%<type>5</type>%' THEN '[链接] ' || COALESCE(
          substr(m.content, instr(m.content, '<title>') + 7,
            instr(m.content, '</title>') - instr(m.content, '<title>') - 7), '')
        ELSE '[分享]'
      END
    WHEN m.type = 10000 THEN '[系统]'
    ELSE m.content
  END as content,
  datetime(m.createTime/1000, 'unixepoch', 'localtime') as timestamp,
  m.type
FROM message m
LEFT JOIN rcontact c ON m.talker = c.username
LEFT JOIN chatroom cr ON m.talker = cr.chatroomname
LEFT JOIN VoiceTransText v ON m.msgId = v.msgId
WHERE m.content IS NOT NULL AND m.content != '';

SELECT 'Indexed ' || count(*) || ' messages' FROM message_fts;
EOF
}

# Main
main() {
  check_deps
  check_emulator

  # Extract key if not saved
  if [ -z "${WECHAT_KEY:-}" ]; then
    extract_key
  fi

  # Find database path
  local db_path
  if [ -n "${WECHAT_DB_FULL_PATH:-}" ]; then
    db_path="$WECHAT_DB_FULL_PATH"
  else
    db_path=$(find_wechat_db)
    echo "WECHAT_DB_FULL_PATH='$db_path'" >> "$CONFIG_FILE" 2>/dev/null || true
  fi

  pull_database "$db_path"
  decrypt_database
  build_search_index

  echo "Done." >&2
}

main "$@"
