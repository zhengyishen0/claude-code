#!/bin/bash
# Build .claude/settings.json from skills/*/*/hooks/settings.yaml
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../../.." && pwd)"
SETTINGS_FILE="$PROJECT_ROOT/.claude/settings.json"

# Read existing settings (preserve env, statusLine, effortLevel)
if [ -f "$SETTINGS_FILE" ]; then
    ENV=$(jq -c '.env // {}' "$SETTINGS_FILE")
    STATUS_LINE=$(jq -c '.statusLine // null' "$SETTINGS_FILE")
    EFFORT_LEVEL=$(jq -r '.effortLevel // "medium"' "$SETTINGS_FILE")
else
    ENV='{}'
    STATUS_LINE='null'
    EFFORT_LEVEL='medium'
fi

# Collect all hooks from YAML files
ALL_HOOKS='[]'

for yaml_file in "$PROJECT_ROOT"/skills/*/*/hooks/settings.yaml; do
    [ -f "$yaml_file" ] || continue

    SKILL_DIR=$(dirname "$(dirname "$yaml_file")")
    SKILL_NAME=$(basename "$SKILL_DIR")
    CATEGORY=$(basename "$(dirname "$SKILL_DIR")")
    SKILL_PATH="$CATEGORY/$SKILL_NAME"

    # Parse YAML to JSON
    if command -v yq &>/dev/null; then
        ENTRIES=$(yq -o=json '.' "$yaml_file" 2>/dev/null || echo '[]')
    else
        ENTRIES=$(python3 -c "
import yaml, json
with open('$yaml_file') as f:
    data = yaml.safe_load(f)
print(json.dumps(data if data else []))
" 2>/dev/null || echo '[]')
    fi

    # Add skill path (category/name) to each entry
    ENTRIES=$(echo "$ENTRIES" | jq --arg skill "$SKILL_PATH" '[.[] | . + {_skill: $skill}]')
    ALL_HOOKS=$(echo "$ALL_HOOKS" "$ENTRIES" | jq -s 'add')
done

# Build hooks object grouped by event
HOOKS=$(echo "$ALL_HOOKS" | jq '
    group_by(.event) |
    map({
        key: .[0].event,
        value: [.[] | {
            hooks: [{
                type: "command",
                command: ("\"$CLAUDE_PROJECT_DIR\"/skills/" + ._skill + "/hooks/" + .script)
            } + (if .timeout then {timeout: .timeout} else {} end)]
        } + (if .matcher then {matcher: .matcher} else {} end)]
    }) |
    from_entries
')

# Build final settings.json
jq -n \
    --argjson env "$ENV" \
    --argjson hooks "$HOOKS" \
    --argjson statusLine "$STATUS_LINE" \
    --arg effortLevel "$EFFORT_LEVEL" \
    '{
        _generated: "Auto-generated by skills/hook/scripts/build.sh",
        env: $env,
        hooks: $hooks,
        statusLine: $statusLine,
        effortLevel: $effortLevel
    } | if .statusLine == null then del(.statusLine) else . end' \
    > "$SETTINGS_FILE"

echo "Built $SETTINGS_FILE from $(echo "$ALL_HOOKS" | jq 'length') hooks"
