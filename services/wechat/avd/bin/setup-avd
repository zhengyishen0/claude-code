#!/bin/bash
# Setup stealth AVD with anti-detection for WeChat
# Creates snapshots at each stage for easy recovery
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WECHAT_DIR="$(dirname "$SCRIPT_DIR")"
DOWNLOADS_DIR="$WECHAT_DIR/downloads"

# Android SDK paths
ANDROID_SDK="/opt/homebrew/share/android-commandlinetools"
EMULATOR="$ANDROID_SDK/emulator/emulator"
AVDMANAGER="$ANDROID_SDK/cmdline-tools/latest/bin/avdmanager"
SDKMANAGER="$ANDROID_SDK/cmdline-tools/latest/bin/sdkmanager"

# AVD config
AVD_NAME="WeChat_Stealth"
SYSTEM_IMAGE="system-images;android-35;google_apis_tablet;arm64-v8a"
DEVICE="pixel_tablet"

# Snapshot names (progressive stages)
SNAP_CLEAN="01_clean_boot"
SNAP_ROOTED="02_magisk_rooted"
SNAP_STEALTH="03_anti_detection"
SNAP_WECHAT="04_wechat_installed"
SNAP_READY="wechat_ready"  # Final production snapshot

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() { echo -e "${BLUE}[setup]${NC} $1"; }
success() { echo -e "${GREEN}[✓]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[✗]${NC} $1" >&2; }

# Required downloads
ROOTAVD_URL="https://github.com/newbit1/rootAVD/archive/refs/heads/master.zip"
SHAMIKO_URL="https://github.com/LSPosed/LSPosed.github.io/releases/download/shamiko-414/Shamiko-v1.2.5-414-release.zip"
FRIDA_VERSION="16.6.6"

usage() {
    cat << 'EOF'
Usage: setup-avd <command>

Build a stealth AVD with anti-detection from scratch.
Creates snapshots at each stage for easy recovery.

Commands:
  all           Run full setup (download → create → root → stealth → wechat)
  download      Download required tools (rootAVD, Magisk, Shamiko, Frida)
  create        Create fresh AVD
  root          Root AVD with Magisk via rootAVD
  stealth       Install anti-detection modules (Shamiko, spoofing)
  wechat        Install WeChat APK
  snapshot      Save current state to production snapshot
  list          List all snapshots
  restore <n>   Restore to snapshot number (1-4) or name
  clean         Delete AVD and start fresh

Snapshots:
  01_clean_boot      - Fresh Android, no modifications
  02_magisk_rooted   - Magisk installed, Zygisk enabled
  03_anti_detection  - Shamiko + device spoofing active
  04_wechat_installed - WeChat installed, ready for login
  wechat_ready       - Production: logged in, key extracted

Example workflow:
  ./setup-avd download    # Get all required files
  ./setup-avd create      # Create fresh AVD
  ./setup-avd root        # Install Magisk
  ./setup-avd stealth     # Add anti-detection
  ./setup-avd wechat      # Install WeChat
  # ... login to WeChat manually ...
  ./setup-avd snapshot    # Save production snapshot
EOF
    exit 1
}

# ============================================================================
# DOWNLOAD PHASE
# ============================================================================

download_tools() {
    log "Downloading required tools..."
    mkdir -p "$DOWNLOADS_DIR"
    cd "$DOWNLOADS_DIR"

    # rootAVD
    if [ ! -d "rootAVD-master" ]; then
        log "Downloading rootAVD..."
        curl -L "$ROOTAVD_URL" -o rootAVD.zip
        unzip -q rootAVD.zip
        rm rootAVD.zip
        success "rootAVD downloaded"
    else
        success "rootAVD already exists"
    fi

    # Magisk APK (rootAVD will download this, but we can pre-fetch)
    if [ ! -f "Magisk.apk" ]; then
        log "Downloading Magisk APK..."
        MAGISK_URL=$(curl -s https://api.github.com/repos/topjohnwu/Magisk/releases/latest | grep "browser_download_url.*Magisk-.*\.apk" | head -1 | cut -d '"' -f 4)
        curl -L "$MAGISK_URL" -o Magisk.apk
        success "Magisk downloaded"
    else
        success "Magisk already exists"
    fi

    # Shamiko module
    if [ ! -f "Shamiko.zip" ]; then
        log "Downloading Shamiko..."
        curl -L "$SHAMIKO_URL" -o Shamiko.zip
        success "Shamiko downloaded"
    else
        success "Shamiko already exists"
    fi

    # Frida server
    FRIDA_FILE="frida-server-${FRIDA_VERSION}-android-arm64.xz"
    if [ ! -f "frida-server" ]; then
        log "Downloading Frida server..."
        curl -L "https://github.com/frida/frida/releases/download/${FRIDA_VERSION}/${FRIDA_FILE}" -o "$FRIDA_FILE"
        xz -d "$FRIDA_FILE"
        mv "frida-server-${FRIDA_VERSION}-android-arm64" frida-server
        success "Frida server downloaded"
    else
        success "Frida server already exists"
    fi

    # Device spoof module (we'll create this)
    create_spoof_module

    success "All tools downloaded to $DOWNLOADS_DIR"
}

create_spoof_module() {
    log "Creating device spoof module..."
    local MODULE_DIR="$DOWNLOADS_DIR/DeviceSpoof"
    mkdir -p "$MODULE_DIR/system/etc"

    # Module metadata
    cat > "$MODULE_DIR/module.prop" << 'PROP'
id=device_spoof
name=Device Spoof - Pixel Tablet
version=1.0
versionCode=1
author=setup-avd
description=Spoofs device properties to look like Pixel Tablet
PROP

    # System properties to override
    cat > "$MODULE_DIR/system.prop" << 'PROP'
# Device identification
ro.product.brand=google
ro.product.device=tangorpro
ro.product.manufacturer=Google
ro.product.model=Pixel Tablet
ro.product.name=tangorpro
ro.build.product=tangorpro

# Build fingerprint
ro.build.fingerprint=google/tangorpro/tangorpro:14/AP2A.240805.005/12025142:user/release-keys
ro.build.description=tangorpro-user 14 AP2A.240805.005 12025142 release-keys

# Hardware
ro.hardware=tangorpro
ro.boot.hardware=tangorpro
ro.board.platform=gs201

# Hide emulator signatures
ro.kernel.qemu=0
ro.kernel.qemu.gles=0
ro.hardware.egl=mali
ro.hardware.vulkan=mali

# Tablet characteristics
ro.build.characteristics=tablet

# Baseband (real devices have this)
gsm.version.baseband=g5300g-230523-240726-B-11608015
ro.baseband=unknown

# Serial (randomized format)
ro.serialno=29231JEHN07319
ro.boot.serialno=29231JEHN07319
PROP

    # Post-fs-data script for additional spoofing
    cat > "$MODULE_DIR/post-fs-data.sh" << 'SCRIPT'
#!/system/bin/sh
# Additional property spoofing at boot

# Reset any emulator-specific props
resetprop ro.kernel.qemu 0
resetprop ro.boot.qemu 0
resetprop ro.hardware.audio.primary goldfish  # Remove if exists
resetprop --delete ro.hardware.audio.primary

# Ensure tablet mode
resetprop ro.build.characteristics tablet
SCRIPT
    chmod 755 "$MODULE_DIR/post-fs-data.sh"

    # Create installable zip
    cd "$DOWNLOADS_DIR"
    rm -f DeviceSpoof.zip
    cd DeviceSpoof
    zip -r ../DeviceSpoof.zip .
    cd "$DOWNLOADS_DIR"

    success "Device spoof module created"
}

# ============================================================================
# AVD CREATION
# ============================================================================

create_avd() {
    log "Creating fresh AVD: $AVD_NAME"

    # Check if system image exists, download google_apis (not tablet) for easier rooting
    if [ ! -d "$ANDROID_SDK/system-images/android-35/google_apis/arm64-v8a" ]; then
        log "Downloading system image (google_apis for rooting compatibility)..."
        "$SDKMANAGER" "system-images;android-35;google_apis_tablet;arm64-v8a"
    fi

    # Delete existing AVD if present
    if [ -d "$HOME/.android/avd/${AVD_NAME}.avd" ]; then
        warn "Deleting existing AVD..."
        "$AVDMANAGER" delete avd -n "$AVD_NAME" 2>/dev/null || true
        rm -rf "$HOME/.android/avd/${AVD_NAME}.avd"
        rm -f "$HOME/.android/avd/${AVD_NAME}.ini"
    fi

    # Create AVD
    log "Creating AVD with Pixel Tablet profile..."
    echo "no" | "$AVDMANAGER" create avd \
        -n "$AVD_NAME" \
        -k "system-images;android-35;google_apis_tablet;arm64-v8a" \
        -d "$DEVICE" \
        --force

    # Configure AVD for stealth
    local CONFIG="$HOME/.android/avd/${AVD_NAME}.avd/config.ini"

    # Append stealth-friendly settings
    cat >> "$CONFIG" << 'CONFIG'

# ============================================
# Stealth & Sensor Settings
# ============================================

# Enable all sensors (critical for anti-detection)
hw.gps=yes
hw.accelerometer=yes
hw.gyroscope=yes
hw.sensors.magnetic_field=yes
hw.sensors.orientation=yes
hw.sensors.proximity=yes
hw.sensors.light=yes
hw.sensors.pressure=yes
hw.sensors.humidity=yes
hw.sensors.temperature=yes
hw.sensor.hinge=yes
hw.sensor.hinge.count=0
hw.sensor.hinge.type=0
hw.sensor.hinge.sub_type=0
hw.sensor.posture_list=
hw.sensor.hinge.fold_to_displayRegion.0.1_at_posture=
hw.sensor.hinge_angles_posture_definitions=

# GPU settings (avoid software renderer detection)
hw.gpu.enabled=yes
hw.gpu.mode=auto

# Realistic storage
disk.dataPartition.size=16G

# Cold boot for rootAVD compatibility (REQUIRED)
fastboot.forceColdBoot=yes
fastboot.forceFastBoot=no

# Network
hw.wifi=yes

# Battery (will be spoofed further via commands)
hw.battery=yes
CONFIG

    success "AVD created: $AVD_NAME"

    # Boot and create clean snapshot
    log "Booting AVD for initial setup..."
    start_emulator_cold

    log "Waiting for boot to complete..."
    wait_for_boot

    log "Saving clean snapshot..."
    save_snapshot "$SNAP_CLEAN"

    stop_emulator
    success "Clean AVD ready with snapshot: $SNAP_CLEAN"
}

# ============================================================================
# ROOTING WITH MAGISK
# ============================================================================

root_avd() {
    log "Rooting AVD with Magisk..."

    # Ensure AVD is running
    ensure_running

    # Check if rootAVD exists
    if [ ! -d "$DOWNLOADS_DIR/rootAVD-master" ]; then
        error "rootAVD not found. Run: ./setup-avd download"
        exit 1
    fi

    cd "$DOWNLOADS_DIR/rootAVD-master"

    # Find the ramdisk path
    local RAMDISK="$ANDROID_SDK/system-images/android-35/google_apis_tablet/arm64-v8a/ramdisk.img"

    if [ ! -f "$RAMDISK" ]; then
        error "Ramdisk not found at: $RAMDISK"
        exit 1
    fi

    log "Running rootAVD (this may take a while)..."
    log "When prompted, select 'Stable' channel (press Enter or type 's')"
    echo ""

    # Run rootAVD - it will prompt for Magisk channel
    ./rootAVD.sh "$RAMDISK" || {
        warn "rootAVD may have completed with warnings, continuing..."
    }

    log "Waiting for AVD to reboot..."
    sleep 15
    wait_for_boot

    # Install Magisk APK if not already installed
    log "Installing Magisk APK..."
    adb -s emulator-5554 install -r "$DOWNLOADS_DIR/Magisk.apk" 2>/dev/null || {
        warn "Magisk APK install failed, may already be installed"
    }

    # Wait for Magisk to initialize
    sleep 5

    # Verify root
    log "Verifying root access..."
    local root_check=0
    for i in 1 2 3 4 5; do
        if adb -s emulator-5554 shell "su -c 'id'" 2>/dev/null | grep -q "uid=0"; then
            root_check=1
            break
        fi
        sleep 3
    done

    if [ $root_check -eq 1 ]; then
        success "Root access verified!"
    else
        warn "Root needs manual setup"
        echo ""
        echo "  Please complete these steps on the emulator:"
        echo "  1. Open Magisk app"
        echo "  2. If prompted 'Requires Additional Setup', tap OK"
        echo "  3. Wait for reboot to complete"
        echo "  4. Open Magisk again → Superuser tab → Enable Shell"
        echo ""
        read -p "Press Enter when done..."
    fi

    # Enable Zygisk via Magisk database
    log "Enabling Zygisk..."
    adb -s emulator-5554 shell "su -c 'magisk --sqlite \"REPLACE INTO settings (key,value) VALUES (\\\"zygisk\\\",1);\"'" 2>/dev/null || {
        warn "Could not enable Zygisk via CLI"
        echo "Please enable manually: Magisk → Settings → Zygisk → ON"
    }

    log "Rebooting to apply Zygisk..."
    adb -s emulator-5554 reboot
    sleep 15
    wait_for_boot

    # Verify Zygisk
    sleep 5
    if adb -s emulator-5554 shell "su -c 'magisk --sqlite \"SELECT value FROM settings WHERE key=\\\"zygisk\\\";\"'" 2>/dev/null | grep -q "1"; then
        success "Zygisk enabled"
    else
        warn "Please verify Zygisk is enabled in Magisk settings"
    fi

    # Save rooted snapshot
    save_snapshot "$SNAP_ROOTED"
    stop_emulator
    success "Magisk installed with snapshot: $SNAP_ROOTED"
}

# ============================================================================
# ANTI-DETECTION SETUP
# ============================================================================

setup_stealth() {
    log "Setting up anti-detection..."

    ensure_running

    # Verify Magisk is working
    if ! adb -s emulator-5554 shell "su -c 'id'" 2>/dev/null | grep -q "uid=0"; then
        error "Root not working. Run: ./setup-avd root"
        exit 1
    fi

    # 1. Install Shamiko module
    log "Installing Shamiko module..."
    adb -s emulator-5554 push "$DOWNLOADS_DIR/Shamiko.zip" /data/local/tmp/
    adb -s emulator-5554 shell "su -c 'magisk --install-module /data/local/tmp/Shamiko.zip'" 2>/dev/null || {
        warn "Shamiko install via CLI failed, trying manual method..."
        adb -s emulator-5554 shell "su -c 'unzip -o /data/local/tmp/Shamiko.zip -d /data/adb/modules/shamiko'" 2>/dev/null || {
            adb -s emulator-5554 shell "su -c 'mkdir -p /data/adb/modules/shamiko && cd /data/adb/modules/shamiko && unzip -o /data/local/tmp/Shamiko.zip'" 2>/dev/null
        }
    }

    # 2. Install device spoof module
    log "Installing device spoof module..."
    adb -s emulator-5554 push "$DOWNLOADS_DIR/DeviceSpoof.zip" /data/local/tmp/
    adb -s emulator-5554 shell "su -c 'mkdir -p /data/adb/modules/device_spoof'"
    adb -s emulator-5554 shell "su -c 'unzip -o /data/local/tmp/DeviceSpoof.zip -d /data/adb/modules/device_spoof'" 2>/dev/null || {
        # Alternative extraction
        adb -s emulator-5554 shell "su -c 'cd /data/adb/modules/device_spoof && /system/bin/unzip -o /data/local/tmp/DeviceSpoof.zip'" 2>/dev/null
    }

    # 3. Configure DenyList for WeChat (Shamiko will use this)
    log "Configuring DenyList for WeChat..."
    # First ensure DenyList enforcement is OFF (Shamiko handles it)
    adb -s emulator-5554 shell "su -c 'magisk --sqlite \"REPLACE INTO settings (key,value) VALUES (\\\"denylist\\\",0);\"'" 2>/dev/null || true

    # Add WeChat to DenyList
    adb -s emulator-5554 shell "su -c 'magisk --denylist add com.tencent.mm'" 2>/dev/null || {
        # Manual SQL insert
        adb -s emulator-5554 shell "su -c 'magisk --sqlite \"INSERT OR IGNORE INTO denylist (package_name,process) VALUES (\\\"com.tencent.mm\\\",\\\"com.tencent.mm\\\");\"'" 2>/dev/null
    }

    # 4. Hide Magisk app
    log "Hiding Magisk app..."
    # Note: This changes the package name, user will need to find it as "Settings" or similar
    adb -s emulator-5554 shell "su -c 'magisk --hide'" 2>/dev/null || {
        warn "Auto-hide failed. Please manually: Magisk → Settings → Hide the Magisk app"
    }

    # 5. Push Frida server (renamed for stealth)
    log "Installing Frida server (stealth mode)..."
    adb -s emulator-5554 push "$DOWNLOADS_DIR/frida-server" /data/local/tmp/hluda-server
    adb -s emulator-5554 shell "su -c 'chmod 755 /data/local/tmp/hluda-server'"

    # Create helper script to start Frida on non-default port
    adb -s emulator-5554 shell "su -c 'echo \"#!/system/bin/sh
/data/local/tmp/hluda-server -l 0.0.0.0:31337 &\" > /data/local/tmp/start-frida.sh && chmod 755 /data/local/tmp/start-frida.sh'"

    # 6. Set realistic battery values
    log "Setting realistic battery values..."
    adb -s emulator-5554 shell "cmd battery unplug" 2>/dev/null || true
    adb -s emulator-5554 shell "cmd battery set level 78" 2>/dev/null || true
    adb -s emulator-5554 shell "cmd battery set temp 301" 2>/dev/null || true  # 30.1°C

    # 7. Clean up temp files
    adb -s emulator-5554 shell "su -c 'rm -f /data/local/tmp/*.zip'" 2>/dev/null || true

    # Reboot to apply all modules
    log "Rebooting to apply modules..."
    adb -s emulator-5554 reboot
    sleep 20
    wait_for_boot

    # Verify stealth setup
    log "Verifying stealth setup..."
    sleep 8

    echo ""
    echo "=== Verification Results ==="

    # Check device model
    local MODEL=$(adb -s emulator-5554 shell getprop ro.product.model 2>/dev/null | tr -d '\r\n')
    if [ "$MODEL" = "Pixel Tablet" ]; then
        success "Device model: $MODEL (spoofed correctly)"
    else
        warn "Device model: $MODEL (spoofing may need manual check)"
    fi

    # Check Shamiko
    if adb -s emulator-5554 shell "su -c 'ls /data/adb/modules/shamiko/module.prop'" 2>/dev/null | grep -q "module.prop"; then
        success "Shamiko module: installed"
    else
        warn "Shamiko module: not found"
    fi

    # Check device_spoof
    if adb -s emulator-5554 shell "su -c 'ls /data/adb/modules/device_spoof/module.prop'" 2>/dev/null | grep -q "module.prop"; then
        success "DeviceSpoof module: installed"
    else
        warn "DeviceSpoof module: not found"
    fi

    # Check Frida
    if adb -s emulator-5554 shell "ls /data/local/tmp/hluda-server" 2>/dev/null | grep -q "hluda"; then
        success "Frida server: installed (stealth name)"
    else
        warn "Frida server: not found"
    fi

    # Check kernel.qemu
    local QEMU=$(adb -s emulator-5554 shell getprop ro.kernel.qemu 2>/dev/null | tr -d '\r\n')
    if [ "$QEMU" = "0" ] || [ -z "$QEMU" ]; then
        success "Emulator signature: hidden (ro.kernel.qemu=$QEMU)"
    else
        warn "Emulator signature: visible (ro.kernel.qemu=$QEMU)"
    fi

    echo ""
    save_snapshot "$SNAP_STEALTH"
    stop_emulator
    success "Anti-detection configured with snapshot: $SNAP_STEALTH"

    echo ""
    echo "Manual verification recommended:"
    echo "  1. Start AVD: ./setup-avd restore 3"
    echo "  2. Open Magisk (may be renamed/hidden)"
    echo "  3. Check: Settings → Zygisk = ON"
    echo "  4. Check: Modules → shamiko & device_spoof = enabled"
    echo "  5. Check: Configure DenyList → com.tencent.mm = checked"
}

# ============================================================================
# WECHAT INSTALLATION
# ============================================================================

install_wechat() {
    log "Installing WeChat..."

    ensure_running

    # Check for WeChat APK
    local WECHAT_APK=""
    for pattern in "weixin" "WeChat" "wechat" "com.tencent.mm"; do
        WECHAT_APK=$(find "$DOWNLOADS_DIR" -maxdepth 1 -name "*${pattern}*.apk" 2>/dev/null | head -1)
        [ -n "$WECHAT_APK" ] && break
    done

    if [ -z "$WECHAT_APK" ]; then
        error "WeChat APK not found in $DOWNLOADS_DIR"
        echo ""
        echo "Please download WeChat APK and place it in: $DOWNLOADS_DIR"
        echo ""
        echo "Download options:"
        echo "  1. Official (China): https://weixin.qq.com/cgi-bin/readtemplate?t=page/faq/android/download"
        echo "  2. APKMirror: https://www.apkmirror.com/apk/tencent/wechat/"
        echo "  3. APKPure: https://apkpure.com/wechat/com.tencent.mm"
        echo ""
        echo "Then run: ./setup-avd wechat"
        exit 1
    fi

    log "Found WeChat APK: $(basename "$WECHAT_APK")"

    # Install WeChat
    adb -s emulator-5554 install -r "$WECHAT_APK" || {
        error "WeChat installation failed"
        exit 1
    }

    # Ensure WeChat is in DenyList (in case it wasn't added before)
    log "Ensuring WeChat is in DenyList..."
    adb -s emulator-5554 shell "su -c 'magisk --denylist add com.tencent.mm'" 2>/dev/null || true

    # Randomize battery again
    local TEMP=$((285 + RANDOM % 60))
    local LEVEL=$((65 + RANDOM % 30))
    adb -s emulator-5554 shell "cmd battery set temp $TEMP" 2>/dev/null || true
    adb -s emulator-5554 shell "cmd battery set level $LEVEL" 2>/dev/null || true

    save_snapshot "$SNAP_WECHAT"
    success "WeChat installed with snapshot: $SNAP_WECHAT"

    echo ""
    echo "=== Next Steps ==="
    echo ""
    echo "1. Open WeChat on the emulator"
    echo "2. Select 'Login via Mobile' (tablet mode)"
    echo "3. Scan QR code with your phone's WeChat"
    echo "4. Complete login on phone"
    echo ""
    echo "After successful login:"
    echo "  ./setup-avd snapshot    # Save production snapshot"
    echo ""
    echo "To extract encryption key (first time only):"
    echo "  ./bin/init              # Uses Frida to extract key"
}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

start_emulator_cold() {
    if pgrep -f "qemu.*$AVD_NAME" > /dev/null; then
        log "Emulator already running"
        return
    fi

    log "Starting emulator (cold boot)..."
    "$EMULATOR" -avd "$AVD_NAME" -no-snapshot-load -no-audio -gpu swiftshader_indirect 2>/dev/null &
    sleep 5
}

ensure_running() {
    if ! adb devices 2>/dev/null | grep -q "emulator-5554.*device"; then
        log "Starting emulator..."
        "$EMULATOR" -avd "$AVD_NAME" -no-snapshot-load -no-audio &
        sleep 5
        wait_for_boot
    fi
}

wait_for_boot() {
    adb wait-for-device 2>/dev/null

    local max_wait=180
    local waited=0
    log "Waiting for boot to complete..."
    while [ $waited -lt $max_wait ]; do
        if adb -s emulator-5554 shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            success "Device booted"
            sleep 5  # Extra time for services to start
            return 0
        fi
        sleep 3
        waited=$((waited + 3))
        echo -n "."
    done
    echo ""
    error "Boot timeout after ${max_wait}s"
    return 1
}

stop_emulator() {
    log "Stopping emulator..."
    adb -s emulator-5554 emu kill 2>/dev/null || true
    sleep 3
}

save_snapshot() {
    local name="$1"
    log "Saving snapshot: $name"
    adb -s emulator-5554 emu avd snapshot save "$name" 2>/dev/null || {
        error "Failed to save snapshot"
        return 1
    }
    success "Snapshot saved: $name"
}

list_snapshots() {
    echo ""
    echo "=== Snapshots for $AVD_NAME ==="
    echo ""

    # Try emulator command first
    if adb devices 2>/dev/null | grep -q "emulator-5554"; then
        adb -s emulator-5554 emu avd snapshot list 2>/dev/null || true
    fi

    # Also check snapshot directory
    local SNAP_DIR="$HOME/.android/avd/${AVD_NAME}.avd/snapshots"
    if [ -d "$SNAP_DIR" ]; then
        echo ""
        echo "Local snapshots:"
        ls -1 "$SNAP_DIR" 2>/dev/null | while read snap; do
            echo "  - $snap"
        done
    fi
}

restore_snapshot() {
    local target="$1"

    if [ -z "$target" ]; then
        echo "Usage: ./setup-avd restore <snapshot>"
        echo ""
        echo "Options:"
        echo "  1 or 01_clean_boot      - Fresh Android"
        echo "  2 or 02_magisk_rooted   - Magisk installed"
        echo "  3 or 03_anti_detection  - Anti-detection active"
        echo "  4 or 04_wechat_installed - WeChat installed"
        echo "  wechat_ready            - Production snapshot"
        exit 1
    fi

    # Map number to snapshot name
    case "$target" in
        1) target="$SNAP_CLEAN" ;;
        2) target="$SNAP_ROOTED" ;;
        3) target="$SNAP_STEALTH" ;;
        4) target="$SNAP_WECHAT" ;;
    esac

    log "Restoring snapshot: $target"

    # Kill any running emulator first
    pkill -f "qemu.*$AVD_NAME" 2>/dev/null || true
    sleep 3

    # Start from snapshot (read-only to preserve it)
    "$EMULATOR" -avd "$AVD_NAME" -snapshot "$target" -no-snapshot-save -no-audio &

    wait_for_boot

    # Reconnect WiFi (common issue after snapshot restore)
    log "Reconnecting WiFi..."
    adb -s emulator-5554 shell "svc wifi disable" 2>/dev/null || true
    sleep 1
    adb -s emulator-5554 shell "svc wifi enable" 2>/dev/null || true
    sleep 2

    success "Restored to: $target"
}

clean_avd() {
    echo ""
    warn "This will DELETE the AVD '$AVD_NAME' and ALL snapshots!"
    echo ""
    read -p "Are you sure? Type 'yes' to confirm: " confirm
    if [ "$confirm" = "yes" ]; then
        log "Cleaning up..."
        pkill -f "qemu.*$AVD_NAME" 2>/dev/null || true
        sleep 2
        "$AVDMANAGER" delete avd -n "$AVD_NAME" 2>/dev/null || true
        rm -rf "$HOME/.android/avd/${AVD_NAME}.avd"
        rm -f "$HOME/.android/avd/${AVD_NAME}.ini"
        success "AVD '$AVD_NAME' deleted"
    else
        log "Cancelled"
    fi
}

run_all() {
    log "=== Full Stealth AVD Setup ==="
    echo ""
    echo "This will:"
    echo "  1. Download tools (rootAVD, Magisk, Shamiko, Frida)"
    echo "  2. Create fresh AVD"
    echo "  3. Root with Magisk + enable Zygisk"
    echo "  4. Install anti-detection (Shamiko, device spoofing)"
    echo "  5. Install WeChat (if APK present)"
    echo ""
    echo "Snapshots will be saved at each stage."
    echo ""
    read -p "Press Enter to continue or Ctrl+C to cancel..."

    download_tools
    create_avd
    root_avd
    setup_stealth

    # Check for WeChat APK
    local WECHAT_APK=""
    for pattern in "weixin" "WeChat" "wechat" "com.tencent.mm"; do
        WECHAT_APK=$(find "$DOWNLOADS_DIR" -maxdepth 1 -name "*${pattern}*.apk" 2>/dev/null | head -1)
        [ -n "$WECHAT_APK" ] && break
    done

    if [ -n "$WECHAT_APK" ]; then
        install_wechat
    else
        warn "WeChat APK not found, skipping install"
        echo "Download WeChat APK to $DOWNLOADS_DIR and run: ./setup-avd wechat"
    fi

    echo ""
    success "=== Setup Complete ==="
    echo ""
    echo "Snapshots created:"
    echo "  1. $SNAP_CLEAN       - Fresh Android"
    echo "  2. $SNAP_ROOTED      - Magisk + Zygisk"
    echo "  3. $SNAP_STEALTH     - Anti-detection active"
    if [ -n "$WECHAT_APK" ]; then
        echo "  4. $SNAP_WECHAT      - WeChat installed"
    fi
    echo ""
    echo "To restore any stage:"
    echo "  ./setup-avd restore <number>"
    echo ""
    echo "To start from anti-detection snapshot:"
    echo "  ./setup-avd restore 3"
}

# ============================================================================
# MAIN
# ============================================================================

case "${1:-}" in
    all)       run_all ;;
    download)  download_tools ;;
    create)    create_avd ;;
    root)      root_avd ;;
    stealth)   setup_stealth ;;
    wechat)    install_wechat ;;
    snapshot)  save_snapshot "$SNAP_READY" ;;
    list)      list_snapshots ;;
    restore)   restore_snapshot "${2:-}" ;;
    clean)     clean_avd ;;
    *)         usage ;;
esac
