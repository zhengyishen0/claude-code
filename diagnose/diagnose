#!/bin/bash
# diagnose - Run language-specific diagnostics on files
# Silent on success, outputs errors only (designed for AI agents)
set -eo pipefail

usage() {
    cat <<EOF
Usage: diagnose <file|directory> [options]

Run language-specific diagnostics on files.
Silent on success, outputs errors only.

Options:
  -v, --verbose   Show output even on success
  -h, --help      Show this help

Supported:
  TypeScript (.ts, .tsx)  → tsc
  JavaScript (.js, .jsx)  → eslint
  Python     (.py)        → ruff / pyright
  Go         (.go)        → go vet + build
  Rust       (.rs)        → cargo check
  Shell      (.sh, .bash) → shellcheck

Examples:
  diagnose src/app.ts
  diagnose src/
  diagnose file.py -v
EOF
    exit 0
}

VERBOSE=false
TARGET=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--verbose) VERBOSE=true; shift ;;
        -h|--help) usage ;;
        -*) echo "Unknown option: $1"; exit 1 ;;
        *) TARGET="$1"; shift ;;
    esac
done

[ -z "$TARGET" ] && usage

if [ ! -e "$TARGET" ]; then
    echo "Error: '$TARGET' not found"
    exit 1
fi

# Detect language from shebang
detect_from_shebang() {
    local shebang
    shebang=$(head -1 "$1" 2>/dev/null)
    case "$shebang" in
        *bash*|*"/bin/sh"*) echo "shell" ;;
        *python*) echo "python" ;;
        *node*) echo "javascript" ;;
        *) echo "" ;;
    esac
}

# Detect language
detect_language() {
    local target="$1"
    if [ -f "$target" ]; then
        case "$target" in
            *.ts|*.tsx) echo "typescript" ;;
            *.js|*.jsx) echo "javascript" ;;
            *.py) echo "python" ;;
            *.go) echo "go" ;;
            *.rs) echo "rust" ;;
            *.sh|*.bash) echo "shell" ;;
            *) detect_from_shebang "$target" || echo "unknown" ;;
        esac
    elif [ -d "$target" ]; then
        if [ -f "$target/tsconfig.json" ]; then echo "typescript"
        elif [ -f "$target/package.json" ]; then echo "javascript"
        elif [ -f "$target/pyproject.toml" ]; then echo "python"
        elif [ -f "$target/go.mod" ]; then echo "go"
        elif [ -f "$target/Cargo.toml" ]; then echo "rust"
        else echo "unknown"
        fi
    fi
}

# Find project root
find_project_root() {
    local dir="$1"
    [ -f "$dir" ] && dir=$(dirname "$dir")
    while [ "$dir" != "/" ]; do
        [ -f "$dir/tsconfig.json" ] || [ -f "$dir/package.json" ] || \
        [ -f "$dir/pyproject.toml" ] || [ -f "$dir/go.mod" ] || \
        [ -f "$dir/Cargo.toml" ] && { echo "$dir"; return; }
        dir=$(dirname "$dir")
    done
    pwd
}

# Run diagnostics
run_diagnostics() {
    local target="$1"
    local lang="$2"
    local root
    root=$(find_project_root "$target")

    case "$lang" in
        typescript)
            command -v tsc &>/dev/null && { cd "$root" && tsc --noEmit 2>&1; return; }
            command -v npx &>/dev/null && { cd "$root" && npx tsc --noEmit 2>&1; return; }
            echo "tsc not found"; return 1
            ;;
        javascript)
            command -v eslint &>/dev/null && { eslint "$target" 2>&1; return; }
            command -v npx &>/dev/null && { npx eslint "$target" 2>&1; return; }
            ;;
        python)
            local out=""
            command -v ruff &>/dev/null && out=$(ruff check "$target" 2>&1) || true
            command -v pyright &>/dev/null && out="$out"$'\n'$(pyright "$target" 2>&1) || true
            [ -n "$out" ] && echo "$out"
            ;;
        go)
            command -v go &>/dev/null || { echo "go not found"; return 1; }
            go vet "$target" 2>&1 || true
            go build -o /dev/null "$target" 2>&1
            ;;
        rust)
            command -v cargo &>/dev/null || { echo "cargo not found"; return 1; }
            cd "$root" && cargo check --message-format short 2>&1
            ;;
        shell)
            command -v shellcheck &>/dev/null || return 0
            shellcheck "$target" 2>&1
            ;;
        *)
            return 0
            ;;
    esac
}

# Main
LANG=$(detect_language "$TARGET")
OUTPUT=$(run_diagnostics "$TARGET" "$LANG" 2>&1) || EXIT_CODE=$?
EXIT_CODE=${EXIT_CODE:-0}

if [ "$EXIT_CODE" -ne 0 ]; then
    echo "Errors in $TARGET:"
    echo "$OUTPUT"
elif $VERBOSE; then
    echo "No errors in $TARGET"
fi

exit $EXIT_CODE
