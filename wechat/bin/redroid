#!/bin/bash
# Redroid container management - runs Android tablet in Docker
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_DIR="$(dirname "$SCRIPT_DIR")/config"

# Load config
source "$CONFIG_DIR/redroid.env" 2>/dev/null || {
    # Defaults if no config
    REDROID_IMAGE="redroid/redroid:14.0.0_64only-latest"
    REDROID_PORT=5556
    REDROID_WIDTH=2560
    REDROID_HEIGHT=1600
    REDROID_DPI=320
}

usage() {
    echo "Usage: $0 <command>"
    echo ""
    echo "Commands:"
    echo "  start     Start Redroid tablet container"
    echo "  stop      Stop Redroid container"
    echo "  restart   Restart Redroid container"
    echo "  logs      Show Redroid logs"
    echo "  shell     ADB shell into Redroid"
    echo "  scrcpy    Open scrcpy window for interaction"
    echo "  install   Install WeChat APK"
    echo "  status    Show Redroid status"
    exit 1
}

ensure_lima() {
    if ! limactl list | grep -q "redroid.*Running"; then
        echo "Starting Lima VM first..."
        "$SCRIPT_DIR/lima" start
    fi
}

start_redroid() {
    ensure_lima

    # Check if already running
    if limactl shell redroid -- sudo docker ps --format '{{.Names}}' | grep -q "^redroid$"; then
        echo "Redroid already running"
        adb connect localhost:$REDROID_PORT 2>/dev/null || true
        return
    fi

    echo "Starting Redroid tablet..."
    limactl shell redroid -- sudo docker rm -f redroid 2>/dev/null || true
    limactl shell redroid -- sudo docker run -d --privileged --name redroid \
        -v /dev/binderfs:/dev/binderfs \
        -p $REDROID_PORT:5555 \
        $REDROID_IMAGE \
        ro.build.characteristics=tablet \
        ro.product.brand=google \
        ro.product.manufacturer=Google \
        ro.product.model=Pixel\ Tablet \
        ro.product.device=tangorpro \
        androidboot.redroid_width=$REDROID_WIDTH \
        androidboot.redroid_height=$REDROID_HEIGHT \
        androidboot.redroid_dpi=$REDROID_DPI

    echo "Waiting for Redroid to boot..."
    sleep 15
    adb connect localhost:$REDROID_PORT
    echo "Redroid tablet ready on localhost:$REDROID_PORT"
}

stop_redroid() {
    echo "Stopping Redroid..."
    limactl shell redroid -- sudo docker stop redroid 2>/dev/null || true
    limactl shell redroid -- sudo docker rm redroid 2>/dev/null || true
    adb disconnect localhost:$REDROID_PORT 2>/dev/null || true
    echo "Done"
}

restart_redroid() {
    stop_redroid
    start_redroid
}

logs_redroid() {
    limactl shell redroid -- sudo docker logs -f redroid
}

shell_redroid() {
    adb -s localhost:$REDROID_PORT shell
}

scrcpy_redroid() {
    scrcpy -s localhost:$REDROID_PORT --window-title "WeChat Tablet (Redroid)"
}

install_wechat() {
    DOWNLOADS_DIR="$(dirname "$SCRIPT_DIR")/downloads"
    APK=$(find "$DOWNLOADS_DIR" -name "*.apk" -o -name "weixin*.apk" 2>/dev/null | head -1)
    if [ -z "$APK" ]; then
        APK=$(find ~/Downloads -name "weixin*.apk" 2>/dev/null | head -1)
    fi
    if [ -z "$APK" ]; then
        echo "WeChat APK not found. Place it in $DOWNLOADS_DIR/"
        exit 1
    fi
    echo "Installing $APK..."
    adb -s localhost:$REDROID_PORT install "$APK"
    echo "Done. Launch with: adb -s localhost:$REDROID_PORT shell am start -n com.tencent.mm/.ui.LauncherUI"
}

status_redroid() {
    echo "=== Redroid Status ==="
    if limactl shell redroid -- sudo docker ps --format '{{.Names}}' 2>/dev/null | grep -q "^redroid$"; then
        echo "Container: Running"
        limactl shell redroid -- sudo docker ps --filter name=redroid
    else
        echo "Container: Stopped"
    fi
    echo ""
    echo "=== ADB ==="
    adb devices | grep localhost:$REDROID_PORT || echo "Not connected"
}

case "${1:-}" in
    start) start_redroid ;;
    stop) stop_redroid ;;
    restart) restart_redroid ;;
    logs) logs_redroid ;;
    shell) shell_redroid ;;
    scrcpy) scrcpy_redroid ;;
    install) install_wechat ;;
    status) status_redroid ;;
    *) usage ;;
esac
