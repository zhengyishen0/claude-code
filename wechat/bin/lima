#!/bin/bash
# Lima VM management for Redroid
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VM_NAME="redroid"

usage() {
    echo "Usage: $0 <command>"
    echo ""
    echo "Commands:"
    echo "  start     Start Lima VM"
    echo "  stop      Stop Lima VM"
    echo "  shell     SSH into Lima VM"
    echo "  status    Show Lima status"
    exit 1
}

start_lima() {
    if limactl list | grep -q "$VM_NAME.*Running"; then
        echo "Lima VM already running"
    else
        echo "Starting Lima VM..."
        limactl start "$VM_NAME"
    fi

    # Setup binder
    echo "Setting up binder..."
    limactl shell "$VM_NAME" -- sudo modprobe binder_linux 2>/dev/null || true
    limactl shell "$VM_NAME" -- sudo mkdir -p /dev/binderfs 2>/dev/null || true
    limactl shell "$VM_NAME" -- sudo mount -t binder binder /dev/binderfs 2>/dev/null || true
    echo "Lima ready"
}

stop_lima() {
    echo "Stopping Lima VM..."
    limactl stop "$VM_NAME"
    echo "Done"
}

shell_lima() {
    limactl shell "$VM_NAME"
}

status_lima() {
    echo "=== Lima Status ==="
    limactl list | grep -E "(NAME|$VM_NAME)"
}

case "${1:-}" in
    start) start_lima ;;
    stop) stop_lima ;;
    shell) shell_lima ;;
    status) status_lima ;;
    *) usage ;;
esac
