#!/bin/bash
# WeChat tool - Manage Android tablet emulator with WeChat
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_help() {
  cat << 'EOF'
wechat - WeChat on Android tablet emulator

USAGE
  wechat start              Start AVD emulator (resumes from snapshot)
  wechat stop               Save snapshot and stop AVD
  wechat status             Show AVD status
  wechat snapshot           Save current state as snapshot

  wechat search "<query>"   Search messages
  wechat sync               Pull latest database from device
  wechat init               First-time setup (extract key, decrypt DB)

  wechat view               Open browser viewer (for headless mode)

SEARCH EXAMPLES
  wechat search "meeting"       # fuzzy search
  wechat search "from:张三"     # filter by sender
  wechat search "type:image"    # filter by type

FIRST TIME SETUP
  1. wechat start             # Start emulator
  2. Log into WeChat (scan QR)
  3. wechat snapshot          # Save logged-in state
  4. wechat init              # Extract key and sync database
  5. wechat search "test"     # Search messages

EOF
}

case "${1:-}" in
  start|stop|status|snapshot|kill)
    "$SCRIPT_DIR/avd" "$1"
    ;;
  search)
    shift
    "$SCRIPT_DIR/search" "$@"
    ;;
  sync)
    "$SCRIPT_DIR/sync"
    ;;
  init)
    "$SCRIPT_DIR/init"
    ;;
  view)
    "$SCRIPT_DIR/view" start
    ;;
  --help|-h|"")
    show_help
    ;;
  *)
    # Treat any other argument as a search query
    "$SCRIPT_DIR/search" "$@"
    ;;
esac
