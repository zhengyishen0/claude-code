#!/bin/bash
# Sync WeChat database from device
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WECHAT_DIR="$(dirname "$SCRIPT_DIR")"
DATA_DIR="$WECHAT_DIR/data"
DEVICE=${SYNC_DEVICE:-"emulator-5554"}  # Default to AVD

usage() {
    echo "Usage: $0 [device]"
    echo ""
    echo "Syncs WeChat database from Android device to local data/ folder"
    echo ""
    echo "Devices:"
    echo "  emulator-5554   AVD (default)"
    echo "  localhost:5556  Redroid"
    echo ""
    echo "Example:"
    echo "  $0                    # Sync from AVD"
    echo "  $0 localhost:5556     # Sync from Redroid"
    exit 1
}

sync_db() {
    local device="${1:-$DEVICE}"

    mkdir -p "$DATA_DIR"

    echo "Finding WeChat data directory on $device..."
    local wechat_uid=$(adb -s "$device" shell "ls /data/data/com.tencent.mm/MicroMsg/ | grep -E '^[a-f0-9]{32}$' | head -1" 2>/dev/null)

    if [ -z "$wechat_uid" ]; then
        echo "Error: WeChat data not found. Make sure WeChat is logged in."
        exit 1
    fi

    echo "Found WeChat UID: $wechat_uid"
    local db_path="/data/data/com.tencent.mm/MicroMsg/$wechat_uid/EnMicroMsg.db"

    echo "Pulling database..."
    adb -s "$device" pull "$db_path" "$DATA_DIR/EnMicroMsg.db" 2>/dev/null || {
        # Try with root
        adb -s "$device" root 2>/dev/null || true
        sleep 2
        adb -s "$device" pull "$db_path" "$DATA_DIR/EnMicroMsg.db"
    }

    echo "Database saved to $DATA_DIR/EnMicroMsg.db"
    ls -lh "$DATA_DIR/EnMicroMsg.db"
}

case "${1:-}" in
    -h|--help) usage ;;
    *) sync_db "$1" ;;
esac
