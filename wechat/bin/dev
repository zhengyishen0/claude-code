#!/bin/bash
# dev - Developer commands for WeChat tool
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WECHAT_DIR="$(dirname "$SCRIPT_DIR")"

# Source state checking library
source "$WECHAT_DIR/lib/state.sh"

show_help() {
    cat << 'EOF'
wechat dev - Developer commands

USAGE
  wechat dev setup              Install emulator and download snapshot
  wechat dev onboard            Run login and import flow (terminal)
  wechat dev onboard --web      Run login and import flow (browser UI)
  wechat dev status             Show current state

EMULATOR CONTROL
  wechat dev start              Start emulator
  wechat dev stop               Save snapshot and stop
  wechat dev kill               Force kill without saving

SNAPSHOT MANAGEMENT
  wechat dev snapshot save      Save current state as snapshot
  wechat dev snapshot export    Export snapshot to file
  wechat dev snapshot import    Import snapshot from file

OTHER
  wechat dev view               Open browser viewer (headless mode)
  wechat dev init               Extract encryption key
EOF
}

main() {
    local cmd="${1:-}"

    case "$cmd" in
        setup)
            do_setup
            ;;
        onboard)
            shift
            if [[ "${1:-}" == "--web" ]]; then
                do_onboard_web
            else
                do_onboard
            fi
            ;;
        status)
            print_status
            ;;
        start)
            "$SCRIPT_DIR/avd" start
            ;;
        stop)
            "$SCRIPT_DIR/avd" stop
            ;;
        kill)
            "$SCRIPT_DIR/avd" kill
            ;;
        snapshot)
            shift
            do_snapshot "$@"
            ;;
        view)
            "$SCRIPT_DIR/view" start
            ;;
        init)
            "$SCRIPT_DIR/init"
            ;;
        --help|-h|help|"")
            show_help
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Run 'wechat dev --help' for usage."
            exit 1
            ;;
    esac
}

do_setup() {
    echo -e "${BOLD}WeChat Search - Setup${NC}"
    echo "====================="
    echo ""

    # Step 1: Check/install emulator tools
    echo -e "${BLUE}[1/2] Checking emulator tools...${NC}"
    if check_emulator_installed; then
        echo "      Emulator tools already installed."
    else
        echo "      Installing Android emulator tools..."
        if command -v brew &>/dev/null; then
            brew install --cask android-commandlinetools
        else
            echo -e "${RED}Error: Homebrew not found. Please install Homebrew first.${NC}"
            echo "  /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
            exit 1
        fi
    fi

    # Step 2: Check/download snapshot
    echo ""
    echo -e "${BLUE}[2/2] Checking AVD snapshot...${NC}"
    if check_avd_exists; then
        echo "      AVD already exists."
    else
        echo "      Downloading pre-built snapshot..."
        download_snapshot
    fi

    echo ""
    echo -e "${GREEN}Setup complete!${NC}"
}

download_snapshot() {
    # TODO: In production, this would download from a hosted location
    # For now, we create the AVD from scratch

    local AVD_NAME="WeChat_Tablet"
    local SDK_MANAGER="/opt/homebrew/share/android-commandlinetools/cmdline-tools/latest/bin/sdkmanager"
    local AVD_MANAGER="/opt/homebrew/share/android-commandlinetools/cmdline-tools/latest/bin/avdmanager"

    echo "      Installing system image..."
    yes | "$SDK_MANAGER" "system-images;android-35;google_apis_playstore;arm64-v8a" 2>/dev/null || true

    echo "      Creating AVD..."
    echo "no" | "$AVD_MANAGER" create avd \
        --name "$AVD_NAME" \
        --package "system-images;android-35;google_apis_playstore;arm64-v8a" \
        --device "pixel_tablet" \
        --force 2>/dev/null || true

    # Configure AVD for tablet mode
    local CONFIG_FILE="$HOME/.android/avd/${AVD_NAME}.avd/config.ini"
    if [[ -f "$CONFIG_FILE" ]]; then
        # Update screen size for tablet
        sed -i '' 's/hw.lcd.width=.*/hw.lcd.width=2560/' "$CONFIG_FILE" 2>/dev/null || true
        sed -i '' 's/hw.lcd.height=.*/hw.lcd.height=1600/' "$CONFIG_FILE" 2>/dev/null || true
    fi

    echo "      AVD created successfully."

    # Download and prepare WeChat APK
    local DOWNLOADS_DIR="$WECHAT_DIR/downloads"
    mkdir -p "$DOWNLOADS_DIR"

    if [[ ! -f "$DOWNLOADS_DIR/wechat.apk" ]]; then
        echo ""
        echo -e "${YELLOW}Note: Please download WeChat APK manually and place it at:${NC}"
        echo "      $DOWNLOADS_DIR/wechat.apk"
        echo ""
        echo "      You can download from: https://www.wandoujia.com/apps/596157"
    fi
}

do_onboard_web() {
    echo -e "${BOLD}WeChat Search - Web Setup${NC}"
    echo "=========================="
    echo ""

    # Check setup first
    if ! check_emulator_installed || ! check_avd_exists; then
        echo "Setup required first. Running setup..."
        do_setup
        echo ""
    fi

    # Start emulator if not running
    if ! adb -s emulator-5554 get-state &>/dev/null; then
        echo -e "${BLUE}Starting emulator...${NC}"
        "$SCRIPT_DIR/avd" start
    fi

    # Open WeChat
    echo -e "${BLUE}Opening WeChat...${NC}"
    adb -s emulator-5554 shell am start -n com.tencent.mm/.ui.LauncherUI 2>/dev/null || true
    sleep 2

    # Start the web server
    echo ""
    echo -e "${BLUE}Starting onboarding server...${NC}"
    "$SCRIPT_DIR/onboard-server"
}

do_onboard() {
    echo -e "${BOLD}WeChat Search - Login${NC}"
    echo "====================="
    echo ""

    # Check setup first
    if ! check_emulator_installed || ! check_avd_exists; then
        echo "Setup required first. Running setup..."
        do_setup
        echo ""
    fi

    # Step 1: Start emulator
    echo -e "${BLUE}Starting emulator...${NC}"
    "$SCRIPT_DIR/avd" start

    # Install WeChat if APK exists
    local APK_PATH="$WECHAT_DIR/downloads/wechat.apk"
    if [[ -f "$APK_PATH" ]]; then
        echo ""
        echo -e "${BLUE}Installing WeChat...${NC}"
        adb -s emulator-5554 install -r "$APK_PATH" 2>/dev/null || true
    fi

    # Open WeChat
    echo ""
    echo -e "${BLUE}Opening WeChat...${NC}"
    adb -s emulator-5554 shell am start -n com.tencent.mm/.ui.LauncherUI 2>/dev/null || true
    sleep 3  # Wait for WeChat to load

    # Navigate to QR code screen
    echo ""
    echo -e "${BLUE}Navigating to login QR code...${NC}"
    navigate_to_qr_code

    # Capture and display QR code
    local QR_FILE="/tmp/wechat-login-qr.png"
    echo ""
    echo -e "${BLUE}Capturing QR code...${NC}"
    adb -s emulator-5554 exec-out screencap -p > "$QR_FILE"

    # Open QR code for user
    echo ""
    echo -e "${BOLD}Step 1/2: Login to WeChat${NC}"
    echo ""
    echo "  A QR code image will open in Preview."
    echo "  Scan it with your phone's WeChat app."
    echo ""
    open "$QR_FILE"
    read -p "  Press Enter when you're logged in... "

    # Step 3: Import chat history
    echo ""
    echo -e "${BOLD}Step 2/2: Import Chat History (Recommended)${NC}"
    echo ""
    echo "  To migrate your chat history to the tablet:"
    echo ""
    echo "  On the TABLET (emulator window):"
    echo "    1. Go to: Me → Settings → Chats → Chat History Migration"
    echo "    2. Choose: Migrate to This Device"
    echo "    3. A QR code will appear on the tablet"
    echo ""
    echo "  On your PHONE:"
    echo "    4. Scan the tablet's QR code with your phone's camera"
    echo "    5. Select which chats to migrate"
    echo "    6. Wait for transfer to complete"
    echo ""
    read -p "  Press Enter when done, or 's' to skip: " choice

    if [[ "$choice" != "s" && "$choice" != "S" ]]; then
        echo ""
        echo "  Waiting for import to complete..."
        echo "  (This may take a while depending on history size)"
        read -p "  Press Enter when import is finished... "
    fi

    # Step 4: Save snapshot
    echo ""
    echo -e "${BLUE}Saving state...${NC}"
    "$SCRIPT_DIR/avd" snapshot

    # Step 5: Extract key and sync
    echo ""
    echo -e "${BLUE}Extracting encryption key...${NC}"
    "$SCRIPT_DIR/init" || true

    # Step 6: Sync database
    echo ""
    echo -e "${BLUE}Syncing database...${NC}"
    "$SCRIPT_DIR/sync" || true

    echo ""
    echo -e "${GREEN}Onboarding complete!${NC}"
    echo ""
    echo "You can now search your messages:"
    echo "  wechat search \"your query\""
    echo ""

    # Stop emulator to save resources
    echo "Stopping emulator..."
    "$SCRIPT_DIR/avd" stop
}

# Navigate to QR code login screen
navigate_to_qr_code() {
    # Dump UI and find "Log in on Phone & Tablet" button
    adb -s emulator-5554 shell uiautomator dump /sdcard/ui.xml 2>/dev/null

    # Extract bounds for "Log in on Phone & Tablet" text using sed
    local bounds=$(adb -s emulator-5554 shell cat /sdcard/ui.xml | sed -n 's/.*text="Log in on Phone \&amp; Tablet"[^>]*bounds="\(\[[0-9,]*\]\[[0-9,]*\]\)".*/\1/p')

    if [[ -z "$bounds" ]]; then
        echo "  Could not find login button. WeChat may already be logged in or on a different screen."
        return 0
    fi

    # Parse bounds [left,top][right,bottom] and calculate center
    # Format: [860,860][1292,913]
    local left=$(echo "$bounds" | sed 's/\[\([0-9]*\),.*/\1/')
    local top=$(echo "$bounds" | sed 's/\[[0-9]*,\([0-9]*\)\].*/\1/')
    local right=$(echo "$bounds" | sed 's/.*\]\[\([0-9]*\),.*/\1/')
    local bottom=$(echo "$bounds" | sed 's/.*,\([0-9]*\)\]$/\1/')

    local center_x=$(( (left + right) / 2 ))
    local center_y=$(( (top + bottom) / 2 ))

    echo "  Tapping login button at ($center_x, $center_y)..."
    adb -s emulator-5554 shell input tap "$center_x" "$center_y"
    sleep 2  # Wait for QR code screen to load
}

do_snapshot() {
    local subcmd="${1:-}"

    case "$subcmd" in
        save)
            "$SCRIPT_DIR/avd" snapshot
            ;;
        export)
            local output="${2:-wechat-snapshot.tar.gz}"
            echo "Exporting snapshot to $output..."
            local AVD_DIR="$HOME/.android/avd/WeChat_Tablet.avd"
            tar -czf "$output" -C "$HOME/.android/avd" "WeChat_Tablet.avd" "WeChat_Tablet.ini"
            echo "Done. File: $output"
            ;;
        import)
            local input="${2:-}"
            if [[ -z "$input" || ! -f "$input" ]]; then
                echo "Usage: wechat dev snapshot import <file.tar.gz>"
                exit 1
            fi
            echo "Importing snapshot from $input..."
            tar -xzf "$input" -C "$HOME/.android/avd"
            echo "Done."
            ;;
        ""|--help)
            echo "Usage: wechat dev snapshot <save|export|import>"
            ;;
        *)
            echo "Unknown snapshot command: $subcmd"
            exit 1
            ;;
    esac
}

main "$@"
